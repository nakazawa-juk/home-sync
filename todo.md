# HomeSync - PDFインポート機能実装 TODO

## 概要

PDFインポート機能の実装を段階的に進めるためのタスク管理

**実装方針**: 固定フォーマット + モックサンプルPDF

---

## Phase 1: サンプルPDF作成・フォーマット定義

### 1.1 標準フォーマット設計

- [x] 工程表の標準フォーマット仕様を定義
- [x] 列構成の決定（工程名、開始予定日、終了予定日、担当者、ステータス、備考）
- [x] サンプルデータの準備（田中様邸新築工事）

### 1.2 サンプルPDF作成

- [x] `/docs/samples/` ディレクトリ作成
- [x] Python + PyMuPDFでサンプルPDF生成スクリプト作成
- [x] `sample_schedule.pdf` ファイル生成
- [x] PDF内容の検証（表構造、データ配置）

### 1.3 PDF品質改善（修正作業）

- [x] 枠線の修正（途中で切れる問題、表からはみ出る問題）
- [x] レイアウト調整（ページ全体の配置、余白の最適化）
- [x] 日本語文字化け対応（フォント設定、エンコーディング修正）
- [x] 表構造の完全修正（全データが表内に収まるよう調整）
- [x] 修正版PDF生成・検証
- [x] PyMuPDF表検出の再テスト

### 1.4 レイアウト最終調整

- [x] 表位置の上寄せ調整（ページ上部1/3に配置）
- [x] マージン・間隔の最適化
- [x] 最終版PDF生成・確認

### 1.5 座標系問題の修正

- [x] 座標系の根本的問題を特定（下→上の逆順表示）
- [x] 正しい座標系での再実装（上→下の正順表示）
- [x] 配置順序の修正（タイトル→プロジェクト情報→工程表）
- [x] 座標系修正版PDF生成・検証

### 1.6 ファイル整理・完成

- [x] 試行錯誤ファイルの削除（v1, v2, v3版のスクリプトとPDF）
- [x] 完全版ファイルのリネーム（シンプルな名前に変更）
- [x] 動作確認・最終検証
- [x] Phase 1 完全完了

### 1.7 データベーススキーマ完全対応

- [x] Supabase DBスキーマとPDFデータの整合性確認
- [x] 不足列の特定（実際開始日・実際終了日・プロジェクト番号）
- [x] PDF表構造の拡張（6列→8列）
- [x] レイアウト最適化（列幅・フォントサイズ調整）
- [x] サンプルデータの実際日付追加
- [x] 仕様書の更新（README.md）
- [x] 完全対応版PDF生成・検証完了

### 1.8 レイアウト改善・長文対応

- [x] 日付フォーマット短縮（25/01/01形式）
- [x] 備考列幅拡大（85px→120px）
- [x] 行高さ拡大（25px→40px、3行分対応）
- [x] フォントサイズ更に縮小（視認性維持しつつ長文対応）
- [x] 長文処理改善（省略廃止、全文表示）
- [x] 修正版PDF生成・検証

### 1.9 ヘッダー文言・フォント調整

- [x] ヘッダー文言変更（「ステータス」→「状況」）
- [x] ヘッダーフォントサイズ統一（本体と同じ8ptに）
- [x] ヘッダーのみ太字設定（hebo使用）
- [x] 仕様書更新（README.md）
- [x] 修正版PDF生成・検証完了

### 将来タスク（Phase 2以降で実装）

- [ ] 工程名列の自動改行対応実装
- [ ] 担当者列の自動改行対応実装
- [ ] 備考列の自動改行対応実装
- [ ] PyMuPDFでのセル内マルチライン表示最適化
- [ ] テキスト折返し・レイアウト自動調整機能

---

## Phase 2: FastAPI PDF処理サービス基盤構築

### 2.1 プロジェクト構造作成

- [ ] `backend/` ディレクトリ作成
- [ ] FastAPIプロジェクト初期化
- [ ] `requirements.txt` 作成（FastAPI, PyMuPDF, Supabase等）
- [ ] `main.py` 基本アプリケーション作成

### 2.2 開発環境構築

- [ ] Python仮想環境セットアップ
- [ ] 依存関係インストール
- [ ] FastAPI開発サーバー起動確認
- [ ] Supabase接続設定

### 2.3 API基本構造

- [ ] `/health` エンドポイント実装
- [ ] CORS設定（Next.js連携用）
- [ ] エラーハンドリング基盤
- [ ] ログ設定

---

## Phase 3: PDF解析機能実装

### 3.1 PyMuPDF解析機能

- [ ] PDFファイル読み込み機能
- [ ] 表構造検出機能（`find_tables()`）
- [ ] 表データ抽出機能
- [ ] データ構造化処理

### 3.2 データバリデーション

- [ ] 工程表データのバリデーション
- [ ] 日付形式の統一処理
- [ ] 必須項目チェック
- [ ] エラーメッセージ定義

### 3.3 Supabase連携

- [ ] プロジェクト存在チェック
- [ ] 工程表バージョン管理
- [ ] データベース保存処理
- [ ] トランザクション管理

### 3.4 APIエンドポイント実装

- [ ] `POST /upload-pdf` エンドポイント
- [ ] ファイルアップロード処理
- [ ] レスポンス形式統一
- [ ] エラーレスポンス処理

---

## Phase 4: Next.js UI連携実装

### 4.1 PDFアップロードUI

- [ ] アップロードページ作成（`/projects/[id]/upload/page.tsx`）
- [ ] ファイル選択コンポーネント
- [ ] ドラッグ&ドロップ機能
- [ ] プログレス表示

### 4.2 バリデーション

- [ ] ファイル形式チェック（PDFのみ）
- [ ] ファイルサイズ制限（10MB）
- [ ] クライアントサイドバリデーション
- [ ] エラー表示UI

### 4.3 FastAPI連携

- [ ] Server Action実装（PDFアップロード）
- [ ] FormData作成・送信
- [ ] FastAPI通信処理
- [ ] レスポンス処理

### 4.4 結果表示

- [ ] アップロード成功表示
- [ ] エラーメッセージ表示
- [ ] 工程表データプレビュー
- [ ] 詳細ページへのリダイレクト

---

## Phase 5: テスト・検証

### 5.1 単体テスト

- [ ] PDF解析機能のテスト
- [ ] データバリデーションテスト
- [ ] Supabase連携テスト
- [ ] エラーハンドリングテスト

### 5.2 結合テスト

- [ ] Next.js ↔ FastAPI連携テスト
- [ ] エンドツーエンドテスト
- [ ] ファイルアップロード全体フローテスト
- [ ] エラーケーステスト

### 5.3 動作検証

- [ ] サンプルPDFでの動作確認
- [ ] データ保存確認
- [ ] UI/UX確認
- [ ] パフォーマンステスト

---

## Phase 6: ドキュメント・改善

### 6.1 ドキュメント整備

- [ ] API仕様書更新
- [ ] フォーマット仕様書作成
- [ ] 使用方法ドキュメント
- [ ] トラブルシューティング

### 6.2 改善・最適化

- [ ] パフォーマンス最適化
- [ ] エラーメッセージ改善
- [ ] UI改善
- [ ] コードレビュー・リファクタリング

---

## 進捗状況

- **開始日**: 2025/08/10
- **現在のフェーズ**: Phase 1
- **完了タスク数**: 0 / 総タスク数: 48
- **進捗率**: 0%

---

## メモ・課題

### 技術的課題

- PyMuPDFの表検出精度の検証が必要
- FastAPIのデプロイ方法（Railway/Render）
- CORS設定の調整

### 設計上の課題

- PDF フォーマットの柔軟性vs実装コストのバランス
- エラーハンドリングの粒度
- ファイルサイズ制限の適切な値

### 今後の拡張

- 複数PDFファイルの一括アップロード
- PDFプレビュー機能
- アップロード履歴管理

---

**最終更新**: 2025/08/10
**更新者**: Claude
